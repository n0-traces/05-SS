# MetaNode Stake ä½¿ç”¨ç¤ºä¾‹

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•ä¸ MetaNode Stake ç³»ç»Ÿäº¤äº’ã€‚

## ğŸ“‹ ç›®å½•

1. [åŸºç¡€è®¾ç½®](#åŸºç¡€è®¾ç½®)
2. [æŸ¥è¯¢æ“ä½œ](#æŸ¥è¯¢æ“ä½œ)
3. [è´¨æŠ¼æ“ä½œ](#è´¨æŠ¼æ“ä½œ)
4. [è§£è´¨æŠ¼å’Œæå–](#è§£è´¨æŠ¼å’Œæå–)
5. [å¥–åŠ±é¢†å–](#å¥–åŠ±é¢†å–)
6. [Web3.js ç¤ºä¾‹](#web3js-ç¤ºä¾‹)
7. [React é›†æˆç¤ºä¾‹](#react-é›†æˆç¤ºä¾‹)

---

## åŸºç¡€è®¾ç½®

### Hardhat è„šæœ¬è®¾ç½®

```javascript
// scripts/examples/basic-setup.js
const hre = require("hardhat");

async function main() {
  // è·å–ç­¾åè€…
  const [deployer, user1, user2] = await ethers.getSigners();

  // åˆçº¦åœ°å€ (æ›¿æ¢ä¸ºä½ çš„éƒ¨ç½²åœ°å€)
  const STAKE_POOL_ADDRESS = "0x...";
  const META_TOKEN_ADDRESS = "0x...";
  const TEST_TOKEN_ADDRESS = "0x...";

  // è¿æ¥åˆ°å·²éƒ¨ç½²çš„åˆçº¦
  const StakePool = await ethers.getContractFactory("StakePool");
  const stakePool = StakePool.attach(STAKE_POOL_ADDRESS);

  const MetaToken = await ethers.getContractFactory("MetaNodeToken");
  const metaToken = MetaToken.attach(META_TOKEN_ADDRESS);

  const TestToken = await ethers.getContractFactory("TestToken");
  const testToken = TestToken.attach(TEST_TOKEN_ADDRESS);

  console.log("åˆçº¦è¿æ¥æˆåŠŸ!");
  console.log("StakePool:", stakePool.address);
  console.log("MetaToken:", metaToken.address);
  console.log("TestToken:", testToken.address);

  return { stakePool, metaToken, testToken, deployer, user1, user2 };
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

---

## æŸ¥è¯¢æ“ä½œ

### 1. æŸ¥è¯¢æ± ä¿¡æ¯

```javascript
// scripts/examples/query-pools.js
async function queryPools(stakePool) {
  console.log("\n========== æŸ¥è¯¢æ± ä¿¡æ¯ ==========\n");

  // è·å–æ± æ•°é‡
  const poolLength = await stakePool.getPoolLength();
  console.log(`æ€»æ± æ•°: ${poolLength}`);

  // éå†æ‰€æœ‰æ± 
  for (let i = 0; i < poolLength; i++) {
    const pool = await stakePool.pools(i);

    console.log(`\næ±  ${i}:`);
    console.log(`  è´¨æŠ¼ä»£å¸: ${pool.stTokenAddress === ethers.ZeroAddress ? "ETH" : pool.stTokenAddress}`);
    console.log(`  æ± æƒé‡: ${pool.poolWeight}`);
    console.log(`  æ€»è´¨æŠ¼é‡: ${ethers.formatEther(pool.stTokenAmount)} ä»£å¸`);
    console.log(`  æœ€å°è´¨æŠ¼: ${ethers.formatEther(pool.minDepositAmount)} ä»£å¸`);
    console.log(`  é”å®šåŒºå—æ•°: ${pool.unstakeLockedBlocks}`);
    console.log(`  æ¿€æ´»çŠ¶æ€: ${pool.isActive ? "æ˜¯" : "å¦"}`);
    console.log(`  ä¸Šæ¬¡å¥–åŠ±åŒºå—: ${pool.lastRewardBlock}`);
    console.log(`  ç´¯ç§¯å¥–åŠ±: ${pool.accMetaNodePerST}`);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool } = await main();
await queryPools(stakePool);
```

### 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

```javascript
// scripts/examples/query-user.js
async function queryUserInfo(stakePool, poolId, userAddress) {
  console.log(`\n========== ç”¨æˆ·ä¿¡æ¯ (æ±  ${poolId}) ==========\n`);

  // è·å–ç”¨æˆ·ä¿¡æ¯
  const userInfo = await stakePool.getUserInfo(poolId, userAddress);

  console.log(`è´¨æŠ¼æ•°é‡: ${ethers.formatEther(userInfo.stAmount)} ä»£å¸`);
  console.log(`å¾…é¢†å–å¥–åŠ±: ${ethers.formatEther(userInfo.pendingReward)} META`);

  // è§£è´¨æŠ¼è¯·æ±‚
  console.log(`\nè§£è´¨æŠ¼è¯·æ±‚ (${userInfo.requests.length} ä¸ª):`);
  if (userInfo.requests.length > 0) {
    const currentBlock = await ethers.provider.getBlockNumber();

    for (let i = 0; i < userInfo.requests.length; i++) {
      const request = userInfo.requests[i];
      const blocksLeft = request.unlockBlock > currentBlock
        ? request.unlockBlock - currentBlock
        : 0;

      console.log(`  è¯·æ±‚ ${i + 1}:`);
      console.log(`    æ•°é‡: ${ethers.formatEther(request.amount)} ä»£å¸`);
      console.log(`    è§£é”åŒºå—: ${request.unlockBlock}`);
      console.log(`    å‰©ä½™åŒºå—: ${blocksLeft} ${blocksLeft === 0 ? "(å¯æå–)" : ""}`);
    }
  }

  // å¯æå–æ•°é‡
  const withdrawable = await stakePool.getWithdrawableAmount(poolId, userAddress);
  console.log(`\nå¯æå–æ•°é‡: ${ethers.formatEther(withdrawable)} ä»£å¸`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool, user1 } = await main();
await queryUserInfo(stakePool, 0, user1.address);
```

### 3. æŸ¥è¯¢å¥–åŠ±ä¿¡æ¯

```javascript
// scripts/examples/query-rewards.js
async function queryRewards(stakePool, poolId, userAddress) {
  console.log(`\n========== å¥–åŠ±ä¿¡æ¯ ==========\n`);

  // æŸ¥è¯¢å¾…é¢†å–å¥–åŠ±
  const pending = await stakePool.pendingMetaNode(poolId, userAddress);
  console.log(`å¾…é¢†å–å¥–åŠ±: ${ethers.formatEther(pending)} META`);

  // æŸ¥è¯¢å…¨å±€å¥–åŠ±ç‡
  const metaNodePerBlock = await stakePool.metaNodePerBlock();
  console.log(`æ¯åŒºå—å¥–åŠ±: ${ethers.formatEther(metaNodePerBlock)} META`);

  // è®¡ç®—ç”¨æˆ·æ¯åŒºå—å¯å¾—å¥–åŠ±
  const pool = await stakePool.pools(poolId);
  const userInfo = await stakePool.getUserInfo(poolId, userAddress);
  const totalPoolWeight = await stakePool.totalPoolWeight();

  if (pool.stTokenAmount > 0n) {
    const poolRewardPerBlock = (metaNodePerBlock * pool.poolWeight) / totalPoolWeight;
    const userRewardPerBlock = (poolRewardPerBlock * userInfo.stAmount) / pool.stTokenAmount;

    console.log(`æ± æ¯åŒºå—å¥–åŠ±: ${ethers.formatEther(poolRewardPerBlock)} META`);
    console.log(`æ‚¨æ¯åŒºå—å¥–åŠ±: ${ethers.formatEther(userRewardPerBlock)} META`);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool, user1 } = await main();
await queryRewards(stakePool, 0, user1.address);
```

---

## è´¨æŠ¼æ“ä½œ

### 1. è´¨æŠ¼ ETH

```javascript
// scripts/examples/stake-eth.js
async function stakeETH(stakePool, poolId, amount) {
  console.log(`\n========== è´¨æŠ¼ ETH ==========\n`);

  const amountWei = ethers.parseEther(amount.toString());

  // æ£€æŸ¥æœ€å°è´¨æŠ¼é‡
  const pool = await stakePool.pools(poolId);
  if (amountWei < pool.minDepositAmount) {
    throw new Error(`è´¨æŠ¼æ•°é‡ä½äºæœ€å°å€¼: ${ethers.formatEther(pool.minDepositAmount)} ETH`);
  }

  console.log(`è´¨æŠ¼æ•°é‡: ${amount} ETH`);
  console.log(`æ±  ID: ${poolId}`);

  // æ‰§è¡Œè´¨æŠ¼
  const tx = await stakePool.stake(poolId, amountWei, { value: amountWei });
  console.log(`äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`);

  const receipt = await tx.wait();
  console.log(`âœ… è´¨æŠ¼æˆåŠŸ! Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`);

  // æŸ¥è¯¢æ›´æ–°åçš„ä¿¡æ¯
  const userInfo = await stakePool.getUserInfo(poolId, await stakePool.signer.getAddress());
  console.log(`å½“å‰è´¨æŠ¼: ${ethers.formatEther(userInfo.stAmount)} ETH`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool } = await main();
await stakeETH(stakePool, 0, 0.1); // è´¨æŠ¼ 0.1 ETH åˆ°æ±  0
```

### 2. è´¨æŠ¼ ERC20

```javascript
// scripts/examples/stake-erc20.js
async function stakeERC20(stakePool, testToken, poolId, amount) {
  console.log(`\n========== è´¨æŠ¼ ERC20 ==========\n`);

  const amountWei = ethers.parseEther(amount.toString());

  // 1. æ£€æŸ¥ä½™é¢
  const userAddress = await stakePool.signer.getAddress();
  const balance = await testToken.balanceOf(userAddress);
  console.log(`å½“å‰ä½™é¢: ${ethers.formatEther(balance)} TST`);

  if (balance < amountWei) {
    throw new Error("ä½™é¢ä¸è¶³");
  }

  // 2. æˆæƒ
  console.log(`\næ­¥éª¤ 1: æˆæƒ ${amount} TST...`);
  const approveTx = await testToken.approve(stakePool.address, amountWei);
  await approveTx.wait();
  console.log(`âœ… æˆæƒæˆåŠŸ`);

  // 3. è´¨æŠ¼
  console.log(`\næ­¥éª¤ 2: è´¨æŠ¼ ${amount} TST...`);
  const stakeTx = await stakePool.stake(poolId, amountWei);
  const receipt = await stakeTx.wait();
  console.log(`âœ… è´¨æŠ¼æˆåŠŸ! Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`);

  // 4. æŸ¥è¯¢æ›´æ–°åçš„ä¿¡æ¯
  const userInfo = await stakePool.getUserInfo(poolId, userAddress);
  console.log(`å½“å‰è´¨æŠ¼: ${ethers.formatEther(userInfo.stAmount)} TST`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool, testToken } = await main();
await stakeERC20(stakePool, testToken, 1, 100); // è´¨æŠ¼ 100 TST åˆ°æ±  1
```

---

## è§£è´¨æŠ¼å’Œæå–

### 1. å‘èµ·è§£è´¨æŠ¼

```javascript
// scripts/examples/unstake.js
async function unstake(stakePool, poolId, amount) {
  console.log(`\n========== å‘èµ·è§£è´¨æŠ¼ ==========\n`);

  const amountWei = ethers.parseEther(amount.toString());
  const userAddress = await stakePool.signer.getAddress();

  // æ£€æŸ¥è´¨æŠ¼ä½™é¢
  const userInfo = await stakePool.getUserInfo(poolId, userAddress);
  console.log(`å½“å‰è´¨æŠ¼: ${ethers.formatEther(userInfo.stAmount)} ä»£å¸`);

  if (userInfo.stAmount < amountWei) {
    throw new Error("è´¨æŠ¼ä½™é¢ä¸è¶³");
  }

  // å‘èµ·è§£è´¨æŠ¼
  console.log(`è§£è´¨æŠ¼æ•°é‡: ${amount} ä»£å¸`);
  const tx = await stakePool.unstake(poolId, amountWei);
  const receipt = await tx.wait();
  console.log(`âœ… è§£è´¨æŠ¼è¯·æ±‚å·²åˆ›å»º! Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`);

  // æŸ¥è¯¢è§£é”åŒºå—
  const pool = await stakePool.pools(poolId);
  const currentBlock = await ethers.provider.getBlockNumber();
  const unlockBlock = currentBlock + Number(pool.unstakeLockedBlocks);

  console.log(`\nè§£é”ä¿¡æ¯:`);
  console.log(`  å½“å‰åŒºå—: ${currentBlock}`);
  console.log(`  è§£é”åŒºå—: ${unlockBlock}`);
  console.log(`  éœ€è¦ç­‰å¾…: ${pool.unstakeLockedBlocks} ä¸ªåŒºå—`);

  // ä¼°ç®—è§£é”æ—¶é—´ (å‡è®¾ 12 ç§’ä¸€ä¸ªåŒºå—)
  const estimatedMinutes = (Number(pool.unstakeLockedBlocks) * 12) / 60;
  console.log(`  é¢„è®¡æ—¶é—´: ~${estimatedMinutes.toFixed(1)} åˆ†é’Ÿ`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool } = await main();
await unstake(stakePool, 0, 0.05); // è§£è´¨æŠ¼ 0.05 ETH
```

### 2. æå–è´¨æŠ¼ä»£å¸

```javascript
// scripts/examples/withdraw.js
async function withdraw(stakePool, poolId) {
  console.log(`\n========== æå–è´¨æŠ¼ä»£å¸ ==========\n`);

  const userAddress = await stakePool.signer.getAddress();

  // æ£€æŸ¥å¯æå–æ•°é‡
  const withdrawable = await stakePool.getWithdrawableAmount(poolId, userAddress);
  console.log(`å¯æå–æ•°é‡: ${ethers.formatEther(withdrawable)} ä»£å¸`);

  if (withdrawable === 0n) {
    console.log("âš ï¸  æ²¡æœ‰å¯æå–çš„ä»£å¸ (å¯èƒ½è¿˜åœ¨é”å®šæœŸ)");
    return;
  }

  // æ‰§è¡Œæå–
  const tx = await stakePool.withdraw(poolId);
  const receipt = await tx.wait();
  console.log(`âœ… æå–æˆåŠŸ! Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`);

  // æŸ¥è¯¢æ›´æ–°åçš„è¯·æ±‚åˆ—è¡¨
  const userInfo = await stakePool.getUserInfo(poolId, userAddress);
  console.log(`å‰©ä½™è§£è´¨æŠ¼è¯·æ±‚: ${userInfo.requests.length} ä¸ª`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool } = await main();
await withdraw(stakePool, 0);
```

### 3. ç´§æ€¥æå–

```javascript
// scripts/examples/emergency-withdraw.js
async function emergencyWithdraw(stakePool, poolId) {
  console.log(`\n========== ç´§æ€¥æå– ==========\n`);
  console.log(`âš ï¸  è­¦å‘Š: ç´§æ€¥æå–å°†æ”¾å¼ƒæ‰€æœ‰å¥–åŠ±!`);

  const userAddress = await stakePool.signer.getAddress();
  const userInfo = await stakePool.getUserInfo(poolId, userAddress);

  console.log(`å°†æå–: ${ethers.formatEther(userInfo.stAmount)} ä»£å¸`);
  console.log(`å°†æ”¾å¼ƒ: ${ethers.formatEther(userInfo.pendingReward)} META å¥–åŠ±`);

  // æ‰§è¡Œç´§æ€¥æå–
  const tx = await stakePool.emergencyWithdraw(poolId);
  const receipt = await tx.wait();
  console.log(`âœ… ç´§æ€¥æå–æˆåŠŸ! Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`);
}

// ä½¿ç”¨ç¤ºä¾‹ (è°¨æ…ä½¿ç”¨!)
const { stakePool } = await main();
// await emergencyWithdraw(stakePool, 0);
```

---

## å¥–åŠ±é¢†å–

### 1. æŸ¥è¯¢å¹¶é¢†å–å¥–åŠ±

```javascript
// scripts/examples/claim-rewards.js
async function claimRewards(stakePool, poolId) {
  console.log(`\n========== é¢†å–å¥–åŠ± ==========\n`);

  const userAddress = await stakePool.signer.getAddress();

  // æŸ¥è¯¢å¾…é¢†å–å¥–åŠ±
  const pending = await stakePool.pendingMetaNode(poolId, userAddress);
  console.log(`å¾…é¢†å–å¥–åŠ±: ${ethers.formatEther(pending)} META`);

  if (pending === 0n) {
    console.log("âš ï¸  æš‚æ— å¾…é¢†å–å¥–åŠ±");
    return;
  }

  // æ‰§è¡Œé¢†å–
  const tx = await stakePool.claim(poolId);
  const receipt = await tx.wait();
  console.log(`âœ… å¥–åŠ±é¢†å–æˆåŠŸ! Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`);

  // éªŒè¯é¢†å–
  const newPending = await stakePool.pendingMetaNode(poolId, userAddress);
  console.log(`å‰©ä½™å¾…é¢†å–: ${ethers.formatEther(newPending)} META`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool } = await main();
await claimRewards(stakePool, 0);
```

### 2. æ‰¹é‡é¢†å–å¥–åŠ±

```javascript
// scripts/examples/claim-all.js
async function claimAllRewards(stakePool) {
  console.log(`\n========== æ‰¹é‡é¢†å–æ‰€æœ‰æ± çš„å¥–åŠ± ==========\n`);

  const userAddress = await stakePool.signer.getAddress();
  const poolLength = await stakePool.getPoolLength();

  let totalRewards = 0n;

  // éå†æ‰€æœ‰æ± 
  for (let i = 0; i < poolLength; i++) {
    const pending = await stakePool.pendingMetaNode(i, userAddress);

    if (pending > 0n) {
      console.log(`\næ±  ${i}:`);
      console.log(`  å¾…é¢†å–: ${ethers.formatEther(pending)} META`);

      try {
        const tx = await stakePool.claim(i);
        await tx.wait();
        console.log(`  âœ… é¢†å–æˆåŠŸ`);
        totalRewards += pending;
      } catch (error) {
        console.log(`  âŒ é¢†å–å¤±è´¥:`, error.message);
      }
    }
  }

  console.log(`\n========== æ€»è®¡ ==========`);
  console.log(`æ€»é¢†å–: ${ethers.formatEther(totalRewards)} META`);
}

// ä½¿ç”¨ç¤ºä¾‹
const { stakePool } = await main();
await claimAllRewards(stakePool);
```

---

## Web3.js ç¤ºä¾‹

### å‰ç«¯é¡µé¢é›†æˆ

```javascript
// frontend/stake.js
const Web3 = require('web3');

// ABI (ç®€åŒ–ç‰ˆï¼Œå®Œæ•´ç‰ˆä» artifacts è·å–)
const STAKE_POOL_ABI = [
  "function stake(uint256 _pid, uint256 _amount) external payable",
  "function unstake(uint256 _pid, uint256 _amount) external",
  "function withdraw(uint256 _pid) external",
  "function claim(uint256 _pid) external",
  "function pendingMetaNode(uint256 _pid, address _user) external view returns (uint256)",
  "function getUserInfo(uint256 _pid, address _user) external view returns (uint256, uint256, tuple(uint256, uint256)[])"
];

class StakeInterface {
  constructor(provider, contractAddress) {
    this.web3 = new Web3(provider);
    this.contract = new this.web3.eth.Contract(STAKE_POOL_ABI, contractAddress);
  }

  // è¿æ¥é’±åŒ…
  async connectWallet() {
    if (window.ethereum) {
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      });
      this.account = accounts[0];
      return this.account;
    }
    throw new Error("è¯·å®‰è£… MetaMask");
  }

  // è´¨æŠ¼ ETH
  async stakeETH(poolId, amount) {
    const amountWei = this.web3.utils.toWei(amount.toString(), 'ether');

    return await this.contract.methods
      .stake(poolId, amountWei)
      .send({
        from: this.account,
        value: amountWei
      });
  }

  // æŸ¥è¯¢å¥–åŠ±
  async getPendingRewards(poolId) {
    const pending = await this.contract.methods
      .pendingMetaNode(poolId, this.account)
      .call();

    return this.web3.utils.fromWei(pending, 'ether');
  }

  // é¢†å–å¥–åŠ±
  async claimRewards(poolId) {
    return await this.contract.methods
      .claim(poolId)
      .send({ from: this.account });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const stakeInterface = new StakeInterface(
  window.ethereum,
  "0x..." // ä½ çš„åˆçº¦åœ°å€
);

await stakeInterface.connectWallet();
await stakeInterface.stakeETH(0, 0.1);
const rewards = await stakeInterface.getPendingRewards(0);
console.log(`å¾…é¢†å–å¥–åŠ±: ${rewards} META`);
```

---

## React é›†æˆç¤ºä¾‹

### React Hook

```jsx
// hooks/useStake.js
import { useState, useEffect } from 'react';
import { ethers } from 'ethers';

export function useStake(contractAddress, abi) {
  const [account, setAccount] = useState(null);
  const [contract, setContract] = useState(null);
  const [userInfo, setUserInfo] = useState(null);

  // è¿æ¥é’±åŒ…
  const connectWallet = async () => {
    if (window.ethereum) {
      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const address = await signer.getAddress();

      setAccount(address);

      const stakeContract = new ethers.Contract(
        contractAddress,
        abi,
        signer
      );
      setContract(stakeContract);

      return address;
    }
  };

  // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
  const fetchUserInfo = async (poolId) => {
    if (!contract || !account) return;

    const info = await contract.getUserInfo(poolId, account);
    const pending = await contract.pendingMetaNode(poolId, account);

    setUserInfo({
      stAmount: ethers.formatEther(info.stAmount),
      pendingReward: ethers.formatEther(pending),
      requests: info.requests
    });
  };

  // è´¨æŠ¼
  const stake = async (poolId, amount) => {
    if (!contract) throw new Error("è¯·å…ˆè¿æ¥é’±åŒ…");

    const amountWei = ethers.parseEther(amount.toString());
    const tx = await contract.stake(poolId, amountWei, { value: amountWei });
    await tx.wait();

    await fetchUserInfo(poolId);
  };

  // é¢†å–å¥–åŠ±
  const claim = async (poolId) => {
    if (!contract) throw new Error("è¯·å…ˆè¿æ¥é’±åŒ…");

    const tx = await contract.claim(poolId);
    await tx.wait();

    await fetchUserInfo(poolId);
  };

  return {
    account,
    userInfo,
    connectWallet,
    fetchUserInfo,
    stake,
    claim
  };
}
```

### React ç»„ä»¶

```jsx
// components/StakePanel.jsx
import React, { useState } from 'react';
import { useStake } from '../hooks/useStake';

export function StakePanel({ contractAddress, abi }) {
  const [poolId] = useState(0);
  const [stakeAmount, setStakeAmount] = useState('');

  const {
    account,
    userInfo,
    connectWallet,
    fetchUserInfo,
    stake,
    claim
  } = useStake(contractAddress, abi);

  const handleConnect = async () => {
    await connectWallet();
    await fetchUserInfo(poolId);
  };

  const handleStake = async () => {
    try {
      await stake(poolId, stakeAmount);
      alert('è´¨æŠ¼æˆåŠŸ!');
      setStakeAmount('');
    } catch (error) {
      alert('è´¨æŠ¼å¤±è´¥: ' + error.message);
    }
  };

  const handleClaim = async () => {
    try {
      await claim(poolId);
      alert('é¢†å–æˆåŠŸ!');
    } catch (error) {
      alert('é¢†å–å¤±è´¥: ' + error.message);
    }
  };

  return (
    <div className="stake-panel">
      {!account ? (
        <button onClick={handleConnect}>è¿æ¥é’±åŒ…</button>
      ) : (
        <div>
          <p>é’±åŒ…åœ°å€: {account.slice(0, 6)}...{account.slice(-4)}</p>

          {userInfo && (
            <div className="user-info">
              <p>å·²è´¨æŠ¼: {userInfo.stAmount} ETH</p>
              <p>å¾…é¢†å–: {userInfo.pendingReward} META</p>
            </div>
          )}

          <div className="stake-form">
            <input
              type="number"
              placeholder="è´¨æŠ¼æ•°é‡ (ETH)"
              value={stakeAmount}
              onChange={(e) => setStakeAmount(e.target.value)}
            />
            <button onClick={handleStake}>è´¨æŠ¼</button>
          </div>

          <button onClick={handleClaim}>é¢†å–å¥–åŠ±</button>
        </div>
      )}
    </div>
  );
}
```

---

## ğŸ¯ å®Œæ•´æµç¨‹ç¤ºä¾‹

### ä»è´¨æŠ¼åˆ°é¢†å–çš„å®Œæ•´æµç¨‹

```javascript
// scripts/examples/complete-flow.js
async function completeStakingFlow() {
  console.log("\n========================================");
  console.log("å®Œæ•´è´¨æŠ¼æµç¨‹æ¼”ç¤º");
  console.log("========================================\n");

  const { stakePool, metaToken, testToken, user1 } = await main();

  // 1. è´¨æŠ¼ ETH
  console.log("æ­¥éª¤ 1: è´¨æŠ¼ 0.1 ETH");
  const stakeAmount = ethers.parseEther("0.1");
  await stakePool.connect(user1).stake(0, stakeAmount, { value: stakeAmount });
  console.log("âœ… è´¨æŠ¼æˆåŠŸ\n");

  // 2. ç­‰å¾…å‡ ä¸ªåŒºå—ç´¯ç§¯å¥–åŠ±
  console.log("æ­¥éª¤ 2: ç­‰å¾…å¥–åŠ±ç´¯ç§¯...");
  for (let i = 0; i < 10; i++) {
    await ethers.provider.send("evm_mine");
  }
  console.log("âœ… å·²æŒ–æ˜ 10 ä¸ªåŒºå—\n");

  // 3. æŸ¥è¯¢å¥–åŠ±
  console.log("æ­¥éª¤ 3: æŸ¥è¯¢å¥–åŠ±");
  const pending = await stakePool.pendingMetaNode(0, user1.address);
  console.log(`å¾…é¢†å–å¥–åŠ±: ${ethers.formatEther(pending)} META\n`);

  // 4. é¢†å–å¥–åŠ±
  console.log("æ­¥éª¤ 4: é¢†å–å¥–åŠ±");
  await stakePool.connect(user1).claim(0);
  const balance = await metaToken.balanceOf(user1.address);
  console.log(`âœ… META ä½™é¢: ${ethers.formatEther(balance)}\n`);

  // 5. å‘èµ·è§£è´¨æŠ¼
  console.log("æ­¥éª¤ 5: å‘èµ·è§£è´¨æŠ¼");
  await stakePool.connect(user1).unstake(0, stakeAmount);
  console.log("âœ… è§£è´¨æŠ¼è¯·æ±‚å·²åˆ›å»º\n");

  // 6. ç­‰å¾…é”å®šæœŸ
  console.log("æ­¥éª¤ 6: ç­‰å¾…é”å®šæœŸ...");
  for (let i = 0; i < 15; i++) {
    await ethers.provider.send("evm_mine");
  }
  console.log("âœ… é”å®šæœŸå·²è¿‡\n");

  // 7. æå–è´¨æŠ¼ä»£å¸
  console.log("æ­¥éª¤ 7: æå–è´¨æŠ¼ä»£å¸");
  const withdrawable = await stakePool.getWithdrawableAmount(0, user1.address);
  console.log(`å¯æå–: ${ethers.formatEther(withdrawable)} ETH`);
  await stakePool.connect(user1).withdraw(0);
  console.log("âœ… æå–æˆåŠŸ\n");

  console.log("========================================");
  console.log("âœ… å®Œæ•´æµç¨‹æ¼”ç¤ºå®Œæˆ!");
  console.log("========================================");
}

// æ‰§è¡Œ
completeStakingFlow()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ•™ç¨‹](./éƒ¨ç½²æ•™ç¨‹.md) - å¦‚ä½•éƒ¨ç½²åˆçº¦
- [README.md](./README.md) - é¡¹ç›®æ¦‚è¿°
- [TEST_GUIDE.md](./TEST_GUIDE.md) - æµ‹è¯•æŒ‡å—

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é”™è¯¯å¤„ç†**: å§‹ç»ˆä½¿ç”¨ try-catch åŒ…è£¹äº¤æ˜“
2. **Gas ä¼°ç®—**: åœ¨å‘é€äº¤æ˜“å‰ä¼°ç®— Gas
3. **äº‹ä»¶ç›‘å¬**: ç›‘å¬åˆçº¦äº‹ä»¶è·å–å®æ—¶æ›´æ–°
4. **ä½™é¢æ£€æŸ¥**: äº¤æ˜“å‰æ£€æŸ¥ä½™é¢å’Œæˆæƒ
5. **ç”¨æˆ·ä½“éªŒ**: æä¾›æ¸…æ™°çš„åŠ è½½çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯

---

Built with â¤ï¸ by MetaNode Academy
